<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Voter Ultimate</title>
    <style>
        /* --- CSS Variables & Theming --- */
        :root {
            --bg-color: #f4f4f5;
            --text-color: #18181b;
            --card-bg: #ffffff;
            --sidebar-bg: #ffffff;
            --modal-overlay: rgba(0, 0, 0, 0.4);
            --shadow: rgba(0, 0, 0, 0.1);
            --accent: #3b82f6;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --heart-color: #ec4899;
            --btn-bg: #e4e4e7;
            --border-color: #d4d4d8;
        }

        [data-theme="dark"] {
            --bg-color: #09090b;
            --text-color: #e4e4e7;
            --card-bg: #18181b;
            --sidebar-bg: #18181b;
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --shadow: rgba(0, 0, 0, 0.5);
            --accent: #60a5fa;
            --accent-green: #4ade80;
            --accent-red: #f87171;
            --heart-color: #f472b6;
            --btn-bg: #27272a;
            --border-color: #3f3f46;
        }

        /* --- Layout --- */
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            transition: background-color 0.3s, color 0.3s;
            overflow: hidden;
        }

        #app-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            height: 100%;
            padding: 1rem;
            box-sizing: border-box;
        }

        /* --- Top Toolbar --- */
        .top-toolbar {
            position: absolute;
            top: 1rem;
            left: 1rem;
            right: 1rem;
            display: flex;
            justify-content: space-between;
            z-index: 10;
            pointer-events: none;
        }

        .icon-btn {
            pointer-events: auto;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            opacity: 0.7;
            transition: all 0.2s;
            box-shadow: 0 2px 5px var(--shadow);
        }

        .icon-btn:hover { opacity: 1; transform: translateY(-1px); }
        .icon-btn svg { width: 24px; height: 24px; fill: currentColor; }

        /* --- Sidebar --- */
        .sidebar-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: var(--modal-overlay);
            z-index: 40;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; }

        .sidebar {
            position: fixed; top: 0; left: -280px;
            width: 280px; height: 100%;
            background: var(--sidebar-bg);
            box-shadow: 5px 0 15px var(--shadow);
            z-index: 50;
            transition: left 0.3s ease-in-out;
            display: flex; flex-direction: column;
            padding: 2rem 1rem; box-sizing: border-box;
        }
        .sidebar.active { left: 0; }

        .sidebar-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }
        .sidebar-title { font-weight: 700; font-size: 1.2rem; }
        
        .menu-list { list-style: none; padding: 0; margin: 0; }
        .menu-item {
            padding: 1rem 0.5rem; border-radius: 8px;
            cursor: pointer; display: flex; align-items: center; gap: 1rem;
            transition: background 0.2s; font-weight: 500;
        }
        .menu-item:hover { background: var(--btn-bg); }
        .menu-item svg { width: 20px; height: 20px; fill: var(--text-color); opacity: 0.8; }
        
        .theme-row { margin-top: auto; border-top: 1px solid var(--border-color); padding-top: 1rem; }

        /* --- Image Area --- */
        .image-wrapper {
            position: relative;
            flex-grow: 1;
            display: flex; align-items: center; justify-content: center;
            width: 100%; overflow: hidden;
            margin-bottom: 1rem; margin-top: 3rem;
        }

        img {
            max-width: 100%; max-height: 100%;
            object-fit: contain; cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px var(--shadow);
            transition: opacity 0.3s ease, transform 0.1s ease;
            opacity: 0;
        }
        img.loaded { opacity: 1; }
        img:active { transform: scale(0.98); }

        /* --- Bottom Controls --- */
        .bottom-panel {
            display: flex; flex-direction: column; align-items: center;
            width: 100%; flex-shrink: 0;
        }

        .controls {
            display: flex; align-items: center; gap: 1rem;
            margin-bottom: 1rem;
        }

        .btn-vote, .btn-aux {
            background-color: var(--btn-bg);
            border: none; border-radius: 50%;
            width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            transition: transform 0.2s, background-color 0.2s, opacity 0.2s;
            color: var(--text-color);
        }

        .btn-vote:hover, .btn-aux:hover { transform: translateY(-2px); }
        .btn-vote:active, .btn-aux:active { transform: scale(0.9); }
        .btn-vote svg, .btn-aux svg { width: 24px; height: 24px; fill: currentColor; }

        /* Specific Button Colors */
        .btn-vote.up.active { background-color: var(--accent-green); color: white; }
        .btn-vote.down.active { background-color: var(--accent-red); color: white; }
        
        .btn-aux.heart.active { color: var(--heart-color); }
        .btn-aux.heart.active svg { fill: var(--heart-color); animation: heartPop 0.3s ease-out; }

        .btn-aux:disabled { opacity: 0.3; cursor: not-allowed; pointer-events: none; }

        @keyframes heartPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.4); }
            100% { transform: scale(1); }
        }

        /* Metadata */
        .metadata { text-align: center; }
        h2 { margin: 0; font-size: 1.1rem; font-weight: 600; }
        p { margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.7; }

        /* --- Loading Spinner --- */
        .loader {
            position: absolute;
            border: 4px solid var(--card-bg);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
            z-index: -1;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Modals --- */
        .modal {
            display: none; position: fixed;
            z-index: 100; left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: var(--modal-overlay);
            align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 2rem; border-radius: 12px;
            width: 90%; max-width: 1400px;
            max-height: 80vh; overflow-y: auto;
            box-shadow: 0 20px 25px -5px var(--shadow);
            position: relative;
            animation: slideUp 0.3s ease-out;
            display: flex; flex-direction: column;
        }

        /* Grid for Favorites */
        .fav-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 1rem;
        }
        .fav-item {
            aspect-ratio: 1;
            background-color: var(--btn-bg);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .fav-item:hover { transform: scale(1.05); }
        .fav-item img {
            width: 100%; height: 100%;
            object-fit: cover;
            opacity: 1;
        }
        .no-favs { text-align: center; opacity: 0.6; margin-top: 2rem; }

        /* Generic Modal Styles */
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close-btn {
            position: absolute; top: 1rem; right: 1rem;
            font-size: 1.5rem; cursor: pointer; line-height: 1; opacity: 0.5;
        }
        .close-btn:hover { opacity: 1; }

        .detail-row {
            display: flex; justify-content: space-between;
            padding: 0.75rem 0; border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        .detail-row:last-child { border-bottom: none; }
        .detail-label { font-weight: 600; opacity: 0.8; }
        .detail-val { opacity: 0.9; text-align: right; }
        
        .detail-link {
            display: block; margin-top: 1.5rem;
            text-align: center; background: var(--accent); color: white;
            text-decoration: none; padding: 0.75rem; border-radius: 8px;
            font-weight: 500; transition: background 0.2s;
        }
        .detail-link:hover { filter: brightness(1.1); }

    </style>
</head>
<body>

    <!-- Sidebar -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span class="sidebar-title">Menu</span>
            <div class="icon-btn" id="closeSidebar" style="width:32px; height:32px; border:none; box-shadow:none; background:transparent;">
                <svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
            </div>
        </div>
        <ul class="menu-list">
            <li class="menu-item" id="menuAbout">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>
                About & Contact
            </li>
            <li class="menu-item" id="menuFavs">
                <!-- Heart Icon -->
                <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <span id="menu-favs-label">My Favorites</span>
            </li>
            <li class="menu-item" id="menuTop">
                <!-- Heart Icon -->
                <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <span id="menu-top-label">Top Rated</span>
            </li>
            <li class="menu-item" id="menuLow">
                <!-- Heart Icon -->
                <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                <span id="menu-low-label">Low Rated</span>
            </li>
        </ul>
        <div class="menu-item theme-row" id="menuThemeToggle">
            <svg viewBox="0 0 24 24"><path d="M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-3.03 0-5.5-2.47-5.5-5.5 0-1.82.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z"/></svg>
            <span>Switch Theme</span>
        </div>
    </nav>

    <!-- Top Toolbar -->
    <div class="top-toolbar">
        <button class="icon-btn" id="hamburgerBtn" title="Menu">
            <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
        </button>
        <button class="icon-btn" id="infoBtn" title="Image Details">
            <svg viewBox="0 0 24 24"><path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/></svg>
        </button>
    </div>

    <!-- Main App Container -->
    <div id="app-container">
        <div class="image-wrapper">
            <div class="loader"></div>
            <img id="display-image" src="" alt="Tap to load new image">
        </div>
        
        <div class="bottom-panel">
            <div class="controls">
               <!-- Vote Up -->
                <button class="btn-vote up" id="btnUp">
                    <svg viewBox="0 0 24 24"><path d="M1 21h4V9H1v12zm22-11c0-1.1-.9-2-2-2h-6.31l.95-4.57.03-.32c0-.41-.17-.79-.44-1.06L14.17 1 7.58 7.59C7.22 7.95 7 8.45 7 9v10c0 1.1.9 2 2 2h9c.83 0 1.54-.5 1.84-1.22l3.02-7.05c.09-.23.14-.47.14-.73v-2z"/></svg>
                </button>
                
                <!-- Vote Down -->
                <button class="btn-vote down" id="btnDown">
                    <svg viewBox="0 0 24 24"><path d="M15 3H6c-.83 0-1.54.5-1.84 1.22l-3.02 7.05c-.09.23-.14.47-.14.73v2c0 1.1.9 2 2 2h6.31l-.95 4.57-.03.32c0 .41.17.79.44 1.06L9.83 23l6.59-6.59c.36-.36.58-.86.58-1.41V5c0-1.1-.9-2-2-2zm4 0v12h4V3h-4z"/></svg>
                </button>

                <!-- Favorite Button -->
                <button class="btn-aux heart" id="btnFav" title="Add to Favorites">
                    <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                </button>
            </div>

            <div class="metadata">
                <a id="meta-author">Loading...</a>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeInfoModal">&times;</span>
            <h2 style="margin-bottom: 1rem;">Image Details</h2>
            <div class="detail-row">
                <span class="detail-label">Author</span>
                <span class="detail-val" id="modal-author">...</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Dimensions</span>
                <span class="detail-val" id="modal-dims">...</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Aspect Ratio</span>
                <span class="detail-val" id="modal-aspect">...</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Image ID</span>
                <span class="detail-val" id="modal-id">...</span>
            </div>
            <a href="#" id="modal-link" class="detail-link" target="_blank">View on Unsplash</a>
        </div>
    </div>

    <!-- About Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeAboutModal">&times;</span>
            <h2 style="margin-bottom: 0.5rem;">About Image Voter</h2>
            <p style="opacity: 0.7; margin-bottom: 1rem;">Version 1.1.0</p>
            <p style="line-height: 1.6; margin-bottom: 1rem;">
                Browse, vote, and collect high-quality photography.
            </p>
            <div class="detail-row"><span class="detail-label">Developer</span><span class="detail-val">Your Name</span></div>
        </div>
    </div>

    <!-- Favorites Modal -->
    <div id="favModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeFavModal">&times;</span>
            <h2 style="margin-bottom: 0.5rem;">My Favorites</h2>
            <div id="favGrid" class="fav-grid">
                <!-- Thumbs injected here -->
            </div>
            <p id="noFavsMsg" class="no-favs">No favorites yet.</p>
        </div>
    </div>

    <script>
        // --- State Management ---
        let historyStack = [];
        let historyIndex = -1;
        let favorites = []
        let userId = null;
        
        let currentPictureData = {
            id: 0,
            isFav: false,
            downvoted: false,
            upvoted: false
        };

        // --- DOM Elements ---
        const imgElement = document.getElementById('display-image');
        const authorText = document.getElementById('meta-author');
        
        const btnUp = document.getElementById('btnUp');
        const btnDown = document.getElementById('btnDown');
        const btnFav = document.getElementById('btnFav');

        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        
        // Modals
        const infoModal = document.getElementById('infoModal');
        const aboutModal = document.getElementById('aboutModal');
        const favModal = document.getElementById('favModal');

        // --- 1. Logic: Loading & History ---

        async function init() {
            userId = localStorage.getItem('userId');
            let userData = null;
            if (userId) {
                const response = await fetch('/user', {
                    method: 'GET',
                    headers: {
                        'uid': userId
                    }
                });
                
                if (!response.ok) {
                    console.warn(`User '${userId}' is not valid. Creating new one.`);
                    userId = null;
                } else {
                    userData = await response.json();
                }
            }

            if (!userId) {
                let retries = 5;
                while (retries-- > 0) {
                    userId = crypto.randomUUID()
                    const response = await fetch('/user', {
                        method: 'POST',
                        headers: {
                            'uid': userId
                        }
                    });

                    if (response.ok) {
                        userData = await response.json();
                        localStorage.setItem('userId', userId);
                        return true;
                    } else {
                        userId = null;
                    }
                }
            }

            if (userId) {
                await initUi(userId, userData);
                await updateFavorites();
                await loadNewImage();
                ///playCarrousel(30);
            } else {
                alert('Error validating user.');
                return false;
            }
        }
        
        async function initUi(uid, userData) {
            if (!userData) {
                const response = await fetch('/user', {
                    method: 'GET',
                    headers: {
                        'uid': uid
                    }
                });
                
                if (response.ok) {
                    userData = await response.json();
                }
            }
            
            if (userData) {
                updateLabelText('menu-favs-label', userData.favsLabel);
                updateLabelText('menu-top-label', userData.topRatedLabel);
                updateLabelText('menu-low-label', userData.lowRatedLabel);
            }
        }
        
        function updateLabelText(id, text) {
            const e = document.getElementById(id);
            e.textContent = text || e.textContent;
        }
        
        async function preload(count)
        {
            for (let c = 0; c < count; c++) {
                const data = await renderImage(null, false, false);
                historyStack.push({...data});
            }

            const max = 100;
            if (historyStack.length > max)
            {
                const i = historyStack.length - max;
                historyStack.splice(0, i);
                historyIndex = historyIndex - i;
                console.log(`History too big, removed ${i} items at the beginning, new index is ${historyIndex}`);
            }
        }
        
        async function loadNewImage(displaySpinner) {
            // Check if we can just move forward in history
            if (historyIndex < historyStack.length - 1) {
                historyIndex++;
                console.log("Rendering image from history index:" + historyIndex);
                currentPictureData = historyStack[historyIndex];
                await renderImage(currentPictureData);
                
                if (historyIndex === historyStack.length - 4) {
                    const ignored = preload(10);
                }
                
                return;
            }

            // Fetch new from API
            if (!(displaySpinner === false))
                updateUIState(true); // set loading state

            console.log("Rendering image from server");
            const data = await renderImage(null, displaySpinner);
            // Add to history
            historyStack.push({...data});
            historyIndex++;
            currentPictureData = historyStack[historyIndex];
            
            const ignored = preload(10);

            updateUIState(false);
        }

        function goBack() {
            if (historyIndex > 0) {
                historyIndex--;
                currentPictureData = historyStack[historyIndex];
                renderImage(currentPictureData);
            }
        }

        async function renderImage(data, displaySpinner = true, render = true) {
            if (render && (!(displaySpinner === false)))
                updateUIState(true); // show loading spinner
            
            let response = null;
            const token = data?.token ? data.token : Math.floor(Math.random() * 999999999);

            if (!data?.blobUrl) {
                let imageUrl = `/picture/next?token=${token}`;
                if (data?.id) {
                    imageUrl = `/picture/${data?.id}?token=${data.token || token}`;
                }
                
                response = await fetch(imageUrl, {
                    method: 'GET',
                    headers: {
                        'uid': userId
                    }
                });
            }
            const pictureData = {};
            pictureData.author = data?.author || response?.headers.get('IG_UserName');
            pictureData.id = data?.id || response?.headers.get('InternalId');
            pictureData.isFav = data?.isFav || Number(response?.headers.get('IsFav'));
            pictureData.upvoted = data?.upvoted || Number(response?.headers.get('Upvoted'));
            pictureData.downvoted = data?.downvoted || Number(response?.headers.get('Downvoted'));
            pictureData.token = data?.token || token;
            pictureData.blobUrl = data?.blobUrl || URL.createObjectURL(await response?.blob());
            pictureData.sourceUrl = data?.sourceUrl || response?.headers.get('SourceUrl');
            
            if (render) {
                imgElement.src = pictureData.blobUrl;
                authorText.innerText = pictureData.author;
                authorText.href = pictureData.sourceUrl;
                authorText.target = '_black';
                imgElement.classList.add('loaded');

                // Update UI buttons
                updateUIState(false);
            }

            return pictureData
        }

        function updateUIState(isLoading) {
            // Reset Vote Buttons
            if(isLoading) {
                imgElement.classList.remove('loaded');
                authorText.innerText = "Loading...";
                //dimsText.innerText = "...";
                btnUp.classList.remove('active');
                btnDown.classList.remove('active');
            }

            let currentData = currentPictureData;
            if (historyIndex >= 0) {
                currentData = historyStack[historyIndex];
            }

            if (currentData.upvoted)
                btnUp.classList.add('active');
            else
                btnUp.classList.remove('active');

            if (currentData.downvoted)
                btnDown.classList.add('active');
            else
                btnDown.classList.remove('active');
            
            // Favorite Button Status
            if(currentData.isFav) btnFav.classList.add('active');
            else btnFav.classList.remove('active');
            
        }

        // --- 2. Logic: Favorites ---

        async function toggleFavorite() {
            let currentData = currentPictureData;
            if (historyIndex >= 0) {
                currentData = historyStack[historyIndex];
            }

            let method;
            if (currentData.isFav) {
                btnFav.classList.remove('active');
                method = 'DELETE';
                currentData.isFav = 0;
            } else {
                // Add
                btnFav.classList.add('active');
                method = 'PUT';
                currentData.isFav = 1;
            }

            currentData.token = Math.floor(Math.random() * 999999999);
            const response = await fetch(`/picture/${currentData.id}/fav`, {
                method: method,
                headers: {
                    'uid': userId
                }
            });
            
            await updateFavorites(await response.json())
        }
        
        async function updateFavorites(favList) {
            if (!favList) {
                const response = await fetch('/user/favs', {
                    method: 'GET',
                    headers: {
                        'uid': userId
                    }
                });

                favList = await response.json();
            }
            
            favorites = favList;
        }

        function renderFavGrid() {
            renderGrid(favorites);
        }
        
        function renderGrid(renderItems) {
            const grid = document.getElementById('favGrid');
            const msg = document.getElementById('noFavsMsg');
            grid.innerHTML = '';

            if (renderItems.length === 0) {
                msg.style.display = 'block';
                return;
            }
            msg.style.display = 'none';

            renderItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'fav-item';
                // Use small thumbnail for grid
                div.innerHTML = `<img src="/picture/${item}/thumb" alt="Fav">`;
                div.onclick = async () => {
                    // Load this favorite into main view
                    const pictureData = await renderImage({id: item});
                    historyStack.push({...pictureData});
                    historyIndex = historyStack.length - 1;
                    currentPictureData = historyStack[historyIndex];
                    updateUIState(false);
                    closeModal(favModal);
                    closeSidebar();
                };
                grid.appendChild(div);
            });
        }
        
        function playCarrousel(delayInSeconds) {
            setInterval(function() {
                loadNewImage(false);
            }, delayInSeconds * 1000);
        }

        // --- 3. Event Listeners ---
        document.addEventListener('keydown', (event) => {
            if (event.key === 'ArrowLeft' || event.keyCode === 37) {
                goBack();
                event.preventDefault();
            } else if (event.key === 'ArrowRight' || event.keyCode === 39) {
                loadNewImage();
                event.preventDefault();
            } else if (event.key === 'ArrowDown') {
                btnDown.click();
                event.preventDefault();
            } else if (event.key === 'ArrowUp') {
                btnUp.click();
                event.preventDefault();
            }
        });

        // Navigation
        imgElement.addEventListener('click', loadNewImage);
        
        // Voting
        btnUp.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            btnUp.classList.toggle('active');

            let currentData = currentPictureData;
            if (historyIndex >= 0) {
                currentData = historyStack[historyIndex];
            }
            
            let method = 'DELETE';
            currentData.upvoted = 0;
            if(btnUp.classList.contains('active')) {
                btnDown.classList.remove('active');
                method = 'PUT';
                currentData.upvoted = 1;
            }
            
            currentData.token = Math.floor(Math.random() * 999999999);
            fetch(`/picture/${currentData.id}/up`, {
                method: method,
                headers: {
                    'uid': userId
                }
            })
        });
        btnDown.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            btnDown.classList.toggle('active');

            let currentData = currentPictureData;
            if (historyIndex >= 0) {
                currentData = historyStack[historyIndex];
            }
            
            let method = 'DELETE';
            currentData.downvoted = 0;
            if(btnDown.classList.contains('active')) {
                btnUp.classList.remove('active');
                method = 'PUT';
                currentData.downvoted = 1;
            }

            currentData.token = Math.floor(Math.random() * 999999999);
            fetch(`/picture/${currentData.id}/down`, {
                method: method,
                headers: {
                    'uid': userId
                }
            })
        });

        // Favorites
        btnFav.addEventListener('click', (e) => { e.stopPropagation(); toggleFavorite(); });

        // Sidebar
        const hamburgerBtn = document.getElementById('hamburgerBtn');
        const closeSidebarBtn = document.getElementById('closeSidebar');
        
        function openSidebar() { sidebar.classList.add('active'); sidebarOverlay.classList.add('active'); }
        function closeSidebar() { sidebar.classList.remove('active'); sidebarOverlay.classList.remove('active'); }
        
        hamburgerBtn.addEventListener('click', openSidebar);
        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // Theme
        const menuThemeToggle = document.getElementById('menuThemeToggle');
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            document.documentElement.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
        }
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
        menuThemeToggle.addEventListener('click', toggleTheme);

        // Modals
        function openModal(el) { el.style.display = 'flex'; closeSidebar(); }
        function closeModal(el) { el.style.display = 'none'; }

        // Info Modal
        document.getElementById('infoBtn').addEventListener('click', () => {
            if (historyIndex < 0) return;
            const d = historyStack[historyIndex];
            document.getElementById('modal-author').innerText = d.author;
            document.getElementById('modal-dims').innerText = `${d.width} x ${d.height}`;
            document.getElementById('modal-id').innerText = d.id;
            document.getElementById('modal-link').href = d.url;
            // Aspect Ratio
            const gcd = (a, b) => b ? gcd(b, a % b) : a;
            const div = gcd(d.width, d.height);
            document.getElementById('modal-aspect').innerText = `${d.width/div}:${d.height/div}`;
            openModal(infoModal);
        });
        document.getElementById('closeInfoModal').addEventListener('click', () => closeModal(infoModal));

        // About Modal
        document.getElementById('menuAbout').addEventListener('click', () => openModal(aboutModal));
        document.getElementById('closeAboutModal').addEventListener('click', () => closeModal(aboutModal));

        // Fav Modal
        document.getElementById('menuFavs').addEventListener('click', () => {
            renderFavGrid();
            openModal(favModal);
        });
        document.getElementById('menuTop').addEventListener('click', async () => {
            const response = await fetch(`/picture/toprated`, {
                method: 'GET',
                headers: {
                    'uid': userId
                }
            });
            renderGrid(await response.json());
            openModal(favModal);
        });
        document.getElementById('menuLow').addEventListener('click', async () => {
            const response = await fetch(`/picture/lowrated`, {
                method: 'GET',
                headers: {
                    'uid': userId
                }
            });
            renderGrid(await response.json());
            openModal(favModal);
        });
        document.getElementById('closeFavModal').addEventListener('click', () => closeModal(favModal));

        // Click Outside Modals
        window.addEventListener('click', (e) => {
            if (e.target == infoModal) closeModal(infoModal);
            if (e.target == aboutModal) closeModal(aboutModal);
            if (e.target == favModal) closeModal(favModal);
        });

        document.addEventListener("DOMContentLoaded", function() {
            // --- Init ---
            init();
        });
        
    </script>
</body>
</html>